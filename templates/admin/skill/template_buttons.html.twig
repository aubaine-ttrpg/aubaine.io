{% set base_template = {
    name: 'New Skill',
    code: 'NEWSKL',
    description: 'Describe the skill effect here.',
    energyCost: null,
    concentration: null,
    ritual: null,
    ultimate: false,
    usageLimitAmount: 0,
    usageLimitPeriod: 'none',
    category: 'general',
    type: 'passive',
    source: 'aubaine_base_rules',
    range: 'none',
    duration: 'none',
    abilities: null,
    tags: [],
    attackRoll: null,
    savingThrow: null,
    abilityCheck: null,
    materials: null
} %}

{% set templates = [
    { label: 'Passive', values: base_template|merge({
        type: 'passive',
        description: 'A basic passive skill.',
        tags: ['warrior']
    }) },
    { label: 'Spell skill', values: base_template|merge({
        type: 'action',
        energyCost: 1,
        abilities: ['intelligence'],
        range: '18m',
        duration: '1_minute',
        concentration: true,
        ritual: false,
        attackRoll: false,
        savingThrow: true,
        abilityCheck: false,
        materials: 'A pinch of dust',
        description: 'A simple spell template.',
        tags: ['wizard', 'verbal', 'somatic', 'material']
    }) }
] %}

<div class="flex flex-wrap items-center gap-2" data-skill-templates data-templates="{{ templates|json_encode|e('html_attr') }}">
    <span class="text-sm text-slate-400 mr-2">Quick templates:</span>
    {% for template in templates %}
        <button type="button" class="btn btn-ghost btn-sm" data-skill-template="{{ template.values|json_encode|e('html_attr') }}">
            {{ template.label }}
        </button>
    {% endfor %}
</div>

<script>
(() => {
    const init = () => {
        const form = document.querySelector('[data-skill-form]');
        const templateButtons = document.querySelectorAll('[data-skill-template]');
        if (!form || templateButtons.length === 0) {
            return;
        }

        const findField = (name) => form.querySelector(`[name$="[${name}]"]`) || form.querySelector(`[name$="[${name}][]"]`);

        const setValue = (name, value) => {
            const field = findField(name);
            if (!field) {
                return;
            }

            if (field.type === 'checkbox') {
                field.checked = Boolean(value);
                field.dispatchEvent(new Event('change', { bubbles: true }));
                return;
            }

            if (field.multiple && Array.isArray(value)) {
                Array.from(field.options).forEach(option => {
                    option.selected = value.includes(option.value);
                });
                field.dispatchEvent(new Event('change', { bubbles: true }));
                return;
            }

            if (value === null || typeof value === 'undefined') {
                field.value = '';
            } else {
                field.value = value;
            }
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
        };

        templateButtons.forEach(button => {
            button.addEventListener('click', () => {
                const payload = button.dataset.skillTemplate ? JSON.parse(button.dataset.skillTemplate) : {};
                Object.entries(payload).forEach(([name, value]) => setValue(name, value));
            });
        });
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
    } else {
        init();
    }
})();
</script>
