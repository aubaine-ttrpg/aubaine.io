{% extends 'base.html.twig' %}

{% set columns = columns|default(9) %}
{% set rows = rows|default(9) %}
{% set placeholder_image = 'https://placehold.co/120?text=?' %}

{% block title %}Skill Tree Builder{% endblock %}

{% block body %}
    <main
        class="grid-test skill-tree-builder max-w-max mx-auto px-4 py-8 print:max-w-full print:p-0 flex flex-col gap-6"
        data-controller="skill-tree-builder"
        data-skill-tree-builder-placeholder-value="{{ placeholder_image }}"
        data-skill-tree-builder-initial-value="{{ initialPayload|json_encode|e('html_attr') }}"
        data-skill-tree-builder-search-url-value="{{ path('dev_skill_tree_search_skills') }}"
    >
        <div class="hide-print flex flex-col gap-4">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-sm text-slate-400">Dev / Skill Tree Builder</p>
                    <h1 class="text-3xl font-semibold">Skill Tree Builder</h1>
                    <p class="text-mono text-sm">Grid size: {{ columns }} x {{ rows }}</p>
                </div>
                <div class="text-sm text-slate-300 max-w-md text-right">
                    Click a cell to edit a node. Hold <strong>Shift</strong> and click two nodes to toggle a link.
                </div>
            </div>

            <form method="post" class="flex flex-col gap-4">
                <input type="hidden" name="_token" value="{{ csrf_token('skill_tree_builder') }}">
                <input type="hidden" name="tree_payload" data-skill-tree-builder-target="payload">

                <div class="grid gap-4 md:grid-cols-2">
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Code
                        <input
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="code"
                            value="{{ tree.code|default('') }}"
                            placeholder="TREE-01"
                            required
                        >
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Name (FR)
                        <input
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="name"
                            value="{{ tree.name|default('') }}"
                            placeholder="Arbre de compétence"
                            required
                        >
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Name (EN)
                        <input
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="name_en"
                            value="{{ translations.en.name|default('') }}"
                            placeholder="Skill Tree"
                        >
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Description (FR)
                        <textarea
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="description"
                            rows="2"
                        >{{ tree.description|default('') }}</textarea>
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Description (EN)
                        <textarea
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="description_en"
                            rows="2"
                        >{{ translations.en.description|default('') }}</textarea>
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Columns
                        <input
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="columns"
                            type="number"
                            min="1"
                            value="{{ columns }}"
                            required
                        >
                    </label>
                    <label class="flex flex-col gap-1 text-sm text-slate-200">
                        Rows
                        <input
                            class="rounded border border-slate-700 bg-slate-900/70 px-3 py-2 text-slate-100"
                            name="rows"
                            type="number"
                            min="1"
                            value="{{ rows }}"
                            required
                        >
                    </label>
                </div>

                <div class="flex items-center gap-3 text-sm">
                    <button class="rounded bg-sky-500 px-4 py-2 font-semibold text-slate-900 hover:bg-sky-400" type="submit">
                        Save Skill Tree
                    </button>
                    <span class="text-slate-400" data-skill-tree-builder-target="status">Ready.</span>
                </div>
            </form>
        </div>

        <section class="grid-test__wrap rounded-sm print:rounded-none">
            <div class="print-title py-[10px] px-[20px] text-black">
                <div class="text-left text-lg font-semibold">Aubaine · Skill Tree Builder</div>
                <hr class="h-1 w-full bg-black border-0">
            </div>
            <div class="grid-test__stage">
                <div class="skill-tree-builder__canvas">
                    <svg class="skill-tree-builder__links" data-skill-tree-builder-target="links"></svg>
                    <div
                        class="grid-test__grid skill-tree-builder__grid"
                        data-skill-tree-builder-target="grid"
                        style="--cols: {{ columns }}; --rows: {{ rows }};"
                    >
                        {% for row in 1..rows %}
                            {% for col in 1..columns %}
                                {% set index = (row - 1) * columns + col %}
                                <button
                                    class="grid-test__cell skill-tree__cell"
                                    type="button"
                                    aria-label="Cell {{ index }}"
                                    aria-pressed="false"
                                    data-row="{{ row }}"
                                    data-col="{{ col }}"
                                    data-action="click->skill-tree-builder#handleCellClick"
                                >
                                    <span class="skill-tree__coords" aria-hidden="true">C{{ col }} R{{ row }}</span>
                                    <span class="grid-test__nameplate" aria-hidden="true">
                                        {{ component('SkillPlate', {
                                            code: 'NAME',
                                            image: placeholder_image,
                                            cost: 0,
                                            isStarter: true
                                        }) }}
                                    </span>
                                </button>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </section>

        <div class="skill-tree-builder__editor" data-skill-tree-builder-target="editor" aria-hidden="true" hidden>
            <div class="skill-tree-builder__editor-panel">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-slate-900">Edit Node</h2>
                    <button class="text-slate-500" type="button" data-action="skill-tree-builder#closeEditor">Close</button>
                </div>
                <div class="grid gap-3 text-sm text-slate-700">
                    <label class="flex flex-col gap-1">
                        Mode
                        <select
                            class="rounded border border-slate-300 px-3 py-2"
                            data-skill-tree-builder-target="modeSelect"
                            data-action="change->skill-tree-builder#updateMode"
                        >
                            <option value="existing">Existing skill</option>
                            <option value="anon">Anonymous skill</option>
                        </select>
                    </label>

                    <div class="grid gap-3" data-skill-tree-builder-target="existingFields">
                        <label class="flex flex-col gap-1 skill-tree-builder__search">
                            Skill search
                            <input
                                class="rounded border border-slate-300 px-3 py-2"
                                data-skill-tree-builder-target="skillSearchInput"
                                data-action="input->skill-tree-builder#searchSkills focus->skill-tree-builder#searchSkills"
                                placeholder="Start typing a code or name..."
                            >
                            <input type="hidden" data-skill-tree-builder-target="skillSearchHidden">
                            <div class="skill-tree-builder__search-results" data-skill-tree-builder-target="skillSearchResults"></div>
                        </label>
                    </div>

                    <div class="grid gap-3" data-skill-tree-builder-target="anonFields">
                        <label class="flex flex-col gap-1">
                            Code
                            <input class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonCode" placeholder="ANON">
                        </label>
                        <label class="flex flex-col gap-1">
                            Name
                            <input class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonName" placeholder="Anonymous skill">
                        </label>
                        <label class="flex flex-col gap-1">
                            Image URL
                            <input class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonIcon" placeholder="https://...">
                        </label>
                        <label class="flex flex-col gap-1">
                            Category
                            <select class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonCategory">
                                <option value="">-- Select --</option>
                                <option value="passive">Passive</option>
                                <option value="upgrade">Upgrade</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1">
                            Ability
                            <select class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonAbility">
                                {% for ability in abilityOptions %}
                                    <option value="{{ ability }}">{{ ('skill.ability.' ~ ability)|trans({}, 'skills') }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="flex flex-col gap-1">
                            Aptitude
                            <select class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="anonAptitude">
                                {% for aptitude in aptitudeOptions %}
                                    <option value="{{ aptitude }}">{{ ('skill.aptitude.' ~ aptitude)|trans({}, 'skills') }}</option>
                                {% endfor %}
                            </select>
                        </label>
                        <label class="flex flex-col gap-1">
                            Description
                            <textarea class="rounded border border-slate-300 px-3 py-2" rows="3" data-skill-tree-builder-target="anonDescription" placeholder="Short description"></textarea>
                        </label>
                    </div>

                    <label class="flex flex-col gap-1">
                        Cost
                        <input class="rounded border border-slate-300 px-3 py-2" data-skill-tree-builder-target="costInput" type="number">
                    </label>

                    <label class="flex items-center gap-2">
                        <input type="checkbox" data-skill-tree-builder-target="starterInput">
                        Starter node
                    </label>
                </div>
                <div class="mt-4 flex items-center justify-between">
                    <button class="text-rose-500" type="button" data-action="skill-tree-builder#clearNode">Clear Node</button>
                    <div class="flex gap-2">
                        <button class="rounded border border-slate-300 px-4 py-2" type="button" data-action="skill-tree-builder#closeEditor">Cancel</button>
                        <button class="rounded bg-slate-900 px-4 py-2 text-white" type="button" data-action="skill-tree-builder#saveNode">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
{% endblock %}
